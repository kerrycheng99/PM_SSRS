--PurPOSheetPrt_注文書発行SQL
DECLARE @PO_NO VARCHAR(10),
        @PRINT_MODE VARCHAR(1),    --0.注文書 1.変更注文書
        @REISSUE_FLAG INT          --0.新発行 1.再発行
SET @PO_NO=''
SET @PRINT_MODE='1'
SET @REISSUE_FLAG=0

SELECT
V.ZIP_CD,V.ADDRESS1,V.ADDRESS2,V.ADDRESS3,V.ADDRESS4,V.VENDOR_DESC,P.VENDOR_CD,
V.VENDOR_ATTN,V.TELNO,V.FAXNO,S.DATA_CHAR COMPANY_NAME,
S.DATA_CHAR3 COMPANY_ADDRESS1,S.DATA_CHAR4 COMPANY_ADDRESS2,
P.BUYER_CD,S.DATA_CHAR5 COMPANY_TELNO,S.DATA_CHAR6 COMPANY_FAXNO,
P.PO_NO,P.PO_LINE_NO,P.ITEM_NO,P.ITEM_DESC,P.PO_QTY,S2.DATA_CHAR PO_UMSR,
P.PO_PRC,P.PO_AMT,S3.DATA_CHAR PO_CUR,P.PO_DUE_DATE,P.JOC_CD,P.ORDER_STATUS
,P.RECV_LOC,P.VENDOR_NAME,P.VENDOR_ITEM_NO,P.VENDOR_ITEM_DESC,P.PO_CHG_TIMES,
CASE ISNULL(S5.DATA_INT,0) WHEN 0 THEN  S4.DATA_INT ELSE S5.DATA_INT END LANG
,S6.DATA_CHAR BUYER_NAME
,ISNULL(S3.DATA_DEC,0) PRC_DEC,    ISNULL(S3.DATA_DEC2,0) AMT_DEC
FROM PUR_ORDER P
LEFT JOIN VENDOR_MASTER V ON P.VENDOR_CD = V.VENDOR_CD
LEFT JOIN SYSTEM_PARAMETER S ON S.KEY01 = 'COMPANY_CD' AND S.KEY02 = '*'
LEFT JOIN SYSTEM_PARAMETER S2 ON S2.KEY01 = 'ITEM_UMSR' AND S2.KEY02 = P.PO_UMSR
LEFT JOIN SYSTEM_PARAMETER S3 ON S3.KEY01 = 'CURRENCY_CD' AND S3.KEY02 = P.PO_CUR 
LEFT JOIN SYSTEM_PARAMETER S4 ON S4.KEY01 = 'PRINT_LANG' AND  S4.KEY02 = '*'
LEFT JOIN SYSTEM_PARAMETER S5 ON S5.KEY01 = 'COUNTRY_CD' AND  S5.KEY02 = V.COUNTRY_CD
LEFT JOIN SYSTEM_PARAMETER S6 ON S6.KEY01 = 'BUYER_CD' AND S6.KEY02 = P.BUYER_CD
WHERE 1 = 1
  AND P.PO_NO IN ( @PO_NO )
  AND ( (@PRINT_MODE = '0' and (@REISSUE_FLAG = 0 
                               or (@REISSUE_FLAG = 1 and P.PO_NO NOT IN ( SELECT PO_NO FROM PUR_ORDER_HISTORY WHERE ORDER_STATUS in (23, 77, 97) )
                                                     and P.PO_ISSUE_FLAG = 1 )) --発注残変更なし
        ) or
       (@PRINT_MODE != '0' and (@REISSUE_FLAG = 0 
                               or (@REISSUE_FLAG = 1 and P.PO_NO IN ( SELECT PO_NO FROM PUR_ORDER_HISTORY WHERE ORDER_STATUS in (23, 77, 97) )
                                                     and P.PO_ISSUE_FLAG = 1 )) --発注残変更あり
        ) )
ORDER BY P.PO_LINE_NO
