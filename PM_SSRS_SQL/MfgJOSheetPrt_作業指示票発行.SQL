--MfgJOSheetPrt_作業指示票発行SQL
DECLARE @JOB_ORDER_NO VARCHAR(100) = ''
DECLARE @WORK_INST_TYPE VARCHAR(1) = ''  --作業指示票形式 NO USE

--[P]の場合作業指示書形式
SELECT
'*' + JO.JOB_ORDER_NO + '*' BAR_CODE,
JO.JOB_ORDER_NO,     JO.WS_CD,       WS.WS_DESC,         JO.SCH_START_DATE,  
JO.SCH_COMPL_DATE,   JO.ITEM_NO,     JO.ITEM_DESC,       JO.JOB_ORDER_QTY,
JO.JOC_CD,           I.DRAWING_NO,   JO.WHS_CD,          JO.INSP_CD,
JO.SCH_ID,  S1.DATA_CHAR SCH_NAME,  S2.DATA_CHAR INSP_NAME,     JO.SLIP_NOTE,
JOD.PROCESS_SEQ, 
JOD.PROCESS_CD,PM.PROCESS_DESC,  JO.ORDER_UMSR,   S3.DATA_CHAR UMSR_NAME,
JOD.SCH_SETUP_TIME + JOD.SCH_WORK_TIME + JOD.SCH_TRANSFER_TIME AS WORK_TIME  
FROM JOB_ORDER   JO
LEFT OUTER JOIN WORKSHOP_MASTER  WS  ON JO.WS_CD    = WS.WS_CD
LEFT OUTER JOIN ITEM_MASTER      I   ON JO.ITEM_NO     = I.ITEM_NO
LEFT OUTER JOIN SYSTEM_PARAMETER S1  ON S1.KEY01='SCH_ID'    AND S1.KEY02 = JO.SCH_ID
LEFT OUTER JOIN SYSTEM_PARAMETER S2  ON S2.KEY01='INSP_CD'   AND S2.KEY02 = JO.INSP_CD
LEFT OUTER JOIN SYSTEM_PARAMETER S3  ON S3.KEY01='ITEM_UMSR' AND S3.KEY02 = JO.ORDER_UMSR
LEFT OUTER JOIN JOB_ORDER_DETAIL JOD ON JO.JOB_ORDER_NO = JOD.JOB_ORDER_NO 
LEFT OUTER JOIN PROCESS_MASTER   PM  ON JOD.PROCESS_CD = PM.PROCESS_CD AND JOD.WS_CD = PM.WS_CD
WHERE 1=1
  AND JO.ITEM_TYPE <> '99'
  AND JO.JOB_ORDER_NO IN ( @JOB_ORDER_NO )
ORDER BY JO.JOB_ORDER_NO ,JO.ITEM_NO ,JOD.PROCESS_SEQ ,JOD.PROCESS_CD

--[P]の場合作業指示書形式Sub
SELECT
'*' + JO.JOB_ORDER_NO + '*' BAR_CODE,
JO.JOB_ORDER_NO,     JO.WS_CD,       WS.WS_DESC,         JO.SCH_START_DATE,  
JO.SCH_COMPL_DATE,   JO.ITEM_NO,     JO.ITEM_DESC,       JO.JOB_ORDER_QTY,
JO.JOC_CD,           I.DRAWING_NO,   JO.WHS_CD,          JO.INSP_CD,
JO.SCH_ID,  S1.DATA_CHAR SCH_NAME,  S2.DATA_CHAR INSP_NAME,     JO.SLIP_NOTE,
JOD.PROCESS_SEQ, 
JOD.PROCESS_CD,PM.PROCESS_DESC,  JO.ORDER_UMSR,   S3.DATA_CHAR UMSR_NAME,
JOD.SCH_SETUP_TIME + JOD.SCH_WORK_TIME + JOD.SCH_TRANSFER_TIME AS WORK_TIME  
FROM JOB_ORDER   JO
LEFT OUTER JOIN WORKSHOP_MASTER  WS  ON JO.WS_CD    = WS.WS_CD
LEFT OUTER JOIN ITEM_MASTER      I   ON JO.ITEM_NO     = I.ITEM_NO
LEFT OUTER JOIN SYSTEM_PARAMETER S1  ON S1.KEY01='SCH_ID'    AND S1.KEY02 = JO.SCH_ID
LEFT OUTER JOIN SYSTEM_PARAMETER S2  ON S2.KEY01='INSP_CD'   AND S2.KEY02 = JO.INSP_CD
LEFT OUTER JOIN SYSTEM_PARAMETER S3  ON S3.KEY01='ITEM_UMSR' AND S3.KEY02 = JO.ORDER_UMSR
LEFT OUTER JOIN JOB_ORDER_DETAIL JOD ON JO.JOB_ORDER_NO = JOD.JOB_ORDER_NO 
LEFT OUTER JOIN PROCESS_MASTER   PM  ON JOD.PROCESS_CD = PM.PROCESS_CD AND JOD.WS_CD = PM.WS_CD
WHERE 1=1
  AND JO.ITEM_TYPE <> '99'
  AND JO.JOB_ORDER_NO = @JOB_ORDER_NO 
  AND JOD.PROCESS_CD  = @PROCESS_CD 
ORDER BY JO.JOB_ORDER_NO ,JO.ITEM_NO ,JOD.PROCESS_SEQ ,JOD.PROCESS_CD

--空白の場合作業指示書形式
SELECT
'*' + JO.JOB_ORDER_NO + '*' BAR_CODE,
JO.JOB_ORDER_NO,     JO.WS_CD,       WS.WS_DESC,         
--JOD.SCH_START_DATE,
--JOD.SCH_COMPL_DATE, 
(SELECT MIN(SCH_START_DATE) FROM JOB_ORDER_DETAIL WHERE JOB_ORDER_NO = JO.JOB_ORDER_NO) SCH_START_DATE,
(SELECT MAX(SCH_START_DATE) FROM JOB_ORDER_DETAIL WHERE JOB_ORDER_NO = JO.JOB_ORDER_NO) SCH_COMPL_DATE,
JO.ITEM_NO,     JO.ITEM_DESC,       JO.JOB_ORDER_QTY,
JO.JOC_CD,           I.DRAWING_NO,   JO.WHS_CD,          JO.INSP_CD,
JO.SCH_ID,  S1.DATA_CHAR SCH_NAME,  S2.DATA_CHAR INSP_NAME,     JO.SLIP_NOTE,
--JOD.PROCESS_SEQ, 
--JOD.PROCESS_CD,PM.PROCESS_DESC,  
JO.ORDER_UMSR,   S3.DATA_CHAR UMSR_NAME,
--JOD.SCH_SETUP_TIME + JOD.SCH_WORK_TIME + JOD.SCH_TRANSFER_TIME AS WORK_TIME
FROM JOB_ORDER   JO
LEFT OUTER JOIN WORKSHOP_MASTER  WS  ON JO.WS_CD = WS.WS_CD
LEFT OUTER JOIN ITEM_MASTER      I   ON JO.ITEM_NO = I.ITEM_NO
LEFT OUTER JOIN SYSTEM_PARAMETER S1  ON S1.KEY01='SCH_ID'    AND S1.KEY02 = JO.SCH_ID
LEFT OUTER JOIN SYSTEM_PARAMETER S2  ON S2.KEY01='INSP_CD'   AND S2.KEY02 = JO.INSP_CD
LEFT OUTER JOIN SYSTEM_PARAMETER S3  ON S3.KEY01='ITEM_UMSR' AND S3.KEY02 = JO.ORDER_UMSR
--LEFT OUTER JOIN JOB_ORDER_DETAIL JOD ON JO.JOB_ORDER_NO = JOD.JOB_ORDER_NO 
--LEFT OUTER JOIN PROCESS_MASTER   PM  ON JOD.PROCESS_CD = PM.PROCESS_CD AND JOD.WS_CD = PM.WS_CD
WHERE 1=1
  AND JO.ITEM_TYPE <> '99'
  AND JO.JOB_ORDER_NO IN ( @JOB_ORDER_NO )
--ORDER BY JO.JOB_ORDER_NO ,JO.ITEM_NO ,JOD.PROCESS_SEQ ,JOD.PROCESS_CD
ORDER BY JO.JOB_ORDER_NO ,JO.ITEM_NO 

--空白の場合作業指示書Sub
SELECT
'*' + JO.JOB_ORDER_NO + '*' BAR_CODE,
JO.JOB_ORDER_NO,     JO.WS_CD,       WS.WS_DESC,         JOD.SCH_START_DATE,
JOD.SCH_COMPL_DATE,   JO.ITEM_NO,     JO.ITEM_DESC,       JO.JOB_ORDER_QTY,
JO.JOC_CD,           I.DRAWING_NO,   JO.WHS_CD,          JO.INSP_CD,
JO.SCH_ID,  S1.DATA_CHAR SCH_NAME,  S2.DATA_CHAR INSP_NAME,     JO.SLIP_NOTE,
JOD.PROCESS_SEQ, 
JOD.PROCESS_CD,PM.PROCESS_DESC,  JO.ORDER_UMSR,   S3.DATA_CHAR UMSR_NAME,
JOD.SCH_SETUP_TIME + JOD.SCH_WORK_TIME + JOD.SCH_TRANSFER_TIME AS WORK_TIME  
FROM JOB_ORDER   JO
LEFT OUTER JOIN WORKSHOP_MASTER  WS  ON JO.WS_CD = WS.WS_CD
LEFT OUTER JOIN ITEM_MASTER      I   ON JO.ITEM_NO = I.ITEM_NO
LEFT OUTER JOIN SYSTEM_PARAMETER S1  ON S1.KEY01='SCH_ID'    AND S1.KEY02 = JO.SCH_ID
LEFT OUTER JOIN SYSTEM_PARAMETER S2  ON S2.KEY01='INSP_CD'   AND S2.KEY02 = JO.INSP_CD
LEFT OUTER JOIN SYSTEM_PARAMETER S3  ON S3.KEY01='ITEM_UMSR' AND S3.KEY02 = JO.ORDER_UMSR
LEFT OUTER JOIN JOB_ORDER_DETAIL JOD ON JO.JOB_ORDER_NO = JOD.JOB_ORDER_NO 
LEFT OUTER JOIN  PROCESS_MASTER  PM  ON JOD.PROCESS_CD = PM.PROCESS_CD AND JOD.WS_CD = PM.WS_CD
WHERE 1=1
  AND JO.ITEM_TYPE <> '99'
  AND JO.JOB_ORDER_NO = @JOB_ORDER_NO 
ORDER BY JO.JOB_ORDER_NO ,JO.ITEM_NO ,JOD.PROCESS_SEQ ,JOD.PROCESS_CD