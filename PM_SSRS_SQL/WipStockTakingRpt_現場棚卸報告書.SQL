--WipStockTakingRpt_現場棚卸報告書 SQL
DECLARE @PHYSICAL_CNT_YYMM INT = 201502
DECLARE @WS_CD VARCHAR(10) = ''
DECLARE @PROCESS_CD VARCHAR(10) = ''
DECLARE @PRC_TYPE INT = 0            --評価単価:0.標準単価 1.月次移動平均単価 2.最終仕入単価

 SELECT  PH.WS_CD,                  WS.WS_DESC,                 PH.PROCESS_CD ,
  PRO.PROCESS_DESC,                  convert(int,PH.PAGE_NO) as PAGE_NO,
  PH.ITEM_NO,                        I.ITEM_DESC ,
  PH.JOC_CD,                         PH.LOT_NO,                  PH.INV_BAL,
  PH.ITEM_UMSR,                      S.DATA_CHAR AS UMSR_NAME ,  PH.PHYSICAL_CNT_QTY,
  PH.DIFF_QTY ,                      PH.PHYSICAL_CNT_YYMM ,      PH.LINE_NO,
  PH.INV_TYPE,
 CASE @PRC_TYPE
      WHEN 0 THEN ISNULL(P1.STD_PRC,0)     --//評価単価=「標準単価」の場合
      WHEN 1 THEN ISNULL(P2.MA_PRC,0)      --//評価単価=月次移動平均単価の場合
      WHEN 2 THEN ISNULL(P2.LAST_RCV_PRC,0)--//評価単価=最終仕入単価の場合
 END  STD_PRC,
 CASE @PRC_TYPE
      WHEN 0 THEN PH.PHYSICAL_CNT_QTY*ISNULL(P1.STD_PRC,0)
      WHEN 1 THEN PH.PHYSICAL_CNT_QTY*ISNULL(P2.MA_PRC,0)
      WHEN 2 THEN PH.PHYSICAL_CNT_QTY*ISNULL(P2.LAST_RCV_PRC,0)
 END  PHYSICAL_CNT_AMT,
 CASE @PRC_TYPE
      WHEN 0 THEN PH.DIFF_QTY*ISNULL(P1.STD_PRC,0)
      WHEN 1 THEN PH.DIFF_QTY*ISNULL(P2.MA_PRC,0)
      WHEN 2 THEN PH.DIFF_QTY*ISNULL(P2.LAST_RCV_PRC,0)
 END  DIFF_AMT,
 CASE @PRC_TYPE
      WHEN 0 THEN ISNULL(P1.AMT_DEC,S1.AMT_DEC)
      WHEN 1 THEN S1.AMT_DEC
      WHEN 2 THEN S1.AMT_DEC
 END  AMT_DEC,
 CASE @PRC_TYPE
      WHEN 0 THEN ISNULL(P1.PRC_DEC,S1.PRC_DEC)
      WHEN 1 THEN S1.PRC_DEC
      WHEN 2 THEN S1.PRC_DEC
 END  PRC_DEC
 FROM PHISICAL_COUNT  PH
 LEFT JOIN WORKSHOP_MASTER WS ON WS.WS_CD=PH.WS_CD
 LEFT JOIN PROCESS_MASTER PRO ON PRO.PROCESS_CD=PH.PROCESS_CD 
 LEFT JOIN ITEM_MASTER  I     ON  PH.ITEM_NO=I.ITEM_NO
 LEFT JOIN SYSTEM_PARAMETER S ON S.KEY01='ITEM_UMSR' AND S.KEY02=PH.ITEM_UMSR
 LEFT JOIN ( --評価単価-標準単価
            SELECT  SPM.ITEM_NO,          SPM.STD_PRC,         SPM.CURRENCY
                   ,S.DATA_DEC PRC_DEC,S.DATA_DEC2 AMT_DEC
            FROM STD_PRICE_MASTER SPM
            LEFT JOIN  SYSTEM_PARAMETER S ON S.KEY01 = 'CURRENCY_CD' AND S.KEY02 = SPM.CURRENCY
            WHERE BEG_EFF_DATE   <=   @PHYSICAL_CNT_YYMM
            AND   END_EFF_DATE   >=   @PHYSICAL_CNT_YYMM
           ) P1   ON PH.ITEM_NO = P1.ITEM_NO
 LEFT JOIN ( --評価単価-月次移動平均単価、最終仕入単価
            SELECT  WHS_CD,    ITEM_NO,     MA_PRC,    LAST_RCV_PRC
            FROM MONTHLY_INV
            WHERE YYMM    =   @PHYSICAL_CNT_YYMM
            --AND  (WHS_CD   =   @WHS_CD or @WHS_CD = '')
           ) P2   ON  PH.WHS_CD    = P2.WHS_CD
                  AND PH.ITEM_NO   = P2.ITEM_NO
 LEFT JOIN ( --基軸通貨 S #
            SELECT ISNULL(DATA_DEC,0) PRC_DEC ,ISNULL(DATA_DEC2,0) AMT_DEC  
            FROM SYSTEM_PARAMETER
            WHERE KEY01     = 'CURRENCY_CD'
            AND   DATA_INT  = 1
           ) S1  ON 1=1
 WHERE 1=1
 AND PH.INV_WIP_TYPE=1 
 AND PH.INV_TYPE IN (0,4)
 AND PH.PHYSICAL_CNT_STATUS=30
 AND (PH.PHYSICAL_CNT_QTY!=0 OR PH.DIFF_QTY!=0)
 AND (PH.PHYSICAL_CNT_YYMM = @PHYSICAL_CNT_YYMM or @PHYSICAL_CNT_YYMM = 0)
 AND (PH.WS_CD = @WS_CD or @WS_CD = '')
 AND (PH.PROCESS_CD = @PROCESS_CD or @PROCESS_CD = '')
 ORDER BY PH.PHYSICAL_CNT_YYMM, PH.WS_CD, PH.PAGE_NO, PH.LINE_NO