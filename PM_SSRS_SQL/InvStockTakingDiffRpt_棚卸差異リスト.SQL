--InvStockTakingDiffRpt_棚卸差異リスト SQL
DECLARE @PHYSICAL_CNT_YYMM INT = 201502
DECLARE @WHS_CD VARCHAR(10) = ''
DECLARE @DIFF_RATE DECIMAL(7,2) = 0
DECLARE @DIFF_AMT DECIMAL(15,2) = 0

 SELECT PH.WHS_CD,                W.WHS_DESC    ,       PH.LINE_NO ,
 PH.PAGE_NO  ,                    PH.LOCATION  ,        PH.ITEM_NO  ,
 I.ITEM_DESC ,                    PH.JOC_CD    ,        PH.LOT_NO  ,
 PH.INV_BAL   ,                   S.DATA_CHAR AS USMR_NAME     ,
 PH.PHYSICAL_CNT_QTY    ,         PH.DIFF_QTY           ,PH.PHYSICAL_CNT_YYMM
 FROM PHISICAL_COUNT  PH
 LEFT JOIN WAREHOUSE_MASTER W ON PH.WHS_CD=W.WHS_CD
 LEFT JOIN ITEM_MASTER  I    ON  PH.ITEM_NO=I.ITEM_NO
 LEFT JOIN SYSTEM_PARAMETER S ON S.KEY01='ITEM_UMSR' AND S.KEY02=PH.ITEM_UMSR
 WHERE 1=1
 AND INV_WIP_TYPE=0
 AND INV_TYPE=0 
 AND PHYSICAL_CNT_STATUS>=20 
 AND DIFF_QTY <>0  
 AND (PH.PHYSICAL_CNT_YYMM = @PHYSICAL_CNT_YYMM or @PHYSICAL_CNT_YYMM = 0)
 AND (PH.WHS_CD = @WHS_CD or @WHS_CD = '')
 AND ( (@DIFF_RATE = 0.0) or
       (@DIFF_RATE <> 0.0
        AND ABS(CASE WHEN INV_BAL<>0 AND DIFF_QTY<>0
                THEN ABS(DIFF_QTY/INV_BAL )*100
                WHEN INV_BAL=0 AND DIFF_QTY<>0 THEN 100
                ELSE 0  END) >= @DIFF_RATE 
       )
     )
 AND ( (@DIFF_AMT = 0.0) or
       (@DIFF_AMT <> 0.0
          AND ABS(DIFF_AMT) >=@DIFF_AMT
       )
     )
 ORDER BY PH.PHYSICAL_CNT_YYMM, PH.WHS_CD, PH.LOCATION, PH.ITEM_NO