--フォーキャスト明細SQL(PurFcstInq)
DECLARE @ITEM_NO VARCHAR(20),
        @VENDOR_CD VARCHAR(10),
        @DATA_TYPE INT,    --0.週単位 1.月単位
        @CALENDAR_DATE INT,
        @TTL_WEEK INT,
        @YEAR INT,
        @MONTH INT
SET @ITEM_NO=''
SET @VENDOR_CD=''
SET @DATA_TYPE=0
SET @TTL_WEEK=8

SELECT
 PO.ITEM_NO
,PO.ITEM_DESC
,CASE PM.DELV_LT_TYPE 
 WHEN 0 THEN convert(varchar,PM.DELV_LT) 
 WHEN 1 THEN convert(varchar,PM.DELV_LT_PROPORTION) 
        + '(LOT:' + convert(varchar,PM.STD_LOT_SIZE) + ')' END DELV_LT 
,SUM(PO.PO_QTY) PO_QTY
,CASE @DATA_TYPE WHEN 0 THEN CAL.TTL_WEEK ELSE CAL.CALENDAR_CYM END DATE_NO
FROM PLANNED_ORDER PO
LEFT JOIN CALENDAR_MASTER CAL ON CAL.CALENDAR_DATE = PO.PO_DUE_DATE
     AND ( (@DATA_TYPE = 1  --Month
            and CAL.CALENDAR_DATE  >= (SELECT MIN(CALENDAR_DATE) from CALENDAR_MASTER WHERE CALENDAR_DATE >= @CALENDAR_DATE)
            and CAL.CALENDAR_DATE  <= (SELECT MAX(CALENDAR_DATE) from CALENDAR_MASTER WHERE CALENDAR_DATE <=
                CONVERT(VARCHAR(8), DATEADD(DAY,-1,(DATEADD(MONTH,8,CONVERT(DATETIME,CONVERT(VARCHAR(8),@CALENDAR_DATE))))), 112))
           ) or 
           (@DATA_TYPE != 1 --Week
            and CAL.CALENDAR_DATE  >= (SELECT MIN(CALENDAR_DATE) from CALENDAR_MASTER WHERE TTL_WEEK = @TTL_WEEK)
            and CAL.CALENDAR_DATE  <= (SELECT MAX(CALENDAR_DATE) from CALENDAR_MASTER WHERE TTL_WEEK = @TTL_WEEK + 7)
           ) )
LEFT OUTER JOIN PURCHASE_MASTER PM ON PM.ITEM_NO  = PO.ITEM_NO
     AND PO.VENDOR_CD = PM.VENDOR_CD
     AND PO.PO_DUE_DATE >= PM.BEG_EFF_DATE
     AND PO.PO_DUE_DATE <= PM.END_EFF_DATE
WHERE 1 = 1
  AND PO.SC_FLAG = 1
  AND PO.ITEM_TYPE <> '99'
  AND PO.VENDOR_CD = @VENDOR_CD
  AND (PO.ITEM_NO LIKE @ITEM_NO or @ITEM_NO = '')
  AND ( (@DATA_TYPE = 1  --Month
            and PO.PO_DUE_DATE >= @CALENDAR_DATE  
            and PO.PO_DUE_DATE <= CONVERT(varchar(8), DATEADD(Month,8,convert(datetime,convert(varchar(8),@CALENDAR_DATE))), 112)
           ) or 
           (@DATA_TYPE != 1 --Week
            and PO.PO_DUE_DATE  >= (SELECT MIN(CALENDAR_DATE) from CALENDAR_MASTER WHERE TTL_WEEK = @TTL_WEEK)
            and PO.PO_DUE_DATE  <= (SELECT MAX(CALENDAR_DATE) from CALENDAR_MASTER WHERE TTL_WEEK = @TTL_WEEK + 7)
           ) )
GROUP BY PO.ITEM_NO, PO.ITEM_DESC
,CASE PM.DELV_LT_TYPE 
WHEN 0 THEN convert(varchar,PM.DELV_LT) 
WHEN 1 THEN convert(varchar,PM.DELV_LT_PROPORTION)   + '(LOT:' + convert(varchar,PM.STD_LOT_SIZE) + ')' END
,CASE @DATA_TYPE WHEN 0 THEN CAL.TTL_WEEK ELSE CAL.CALENDAR_CYM END
ORDER BY PO.ITEM_NO


