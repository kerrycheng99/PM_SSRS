--InvStockTakingRpt_棚卸報告書 SQL
DECLARE @PHYSICAL_CNT_YYMM INT = 201502
DECLARE @WHS_CD VARCHAR(10) = ''
DECLARE @PRC_TYPE INT = 0            --評価単価:0.標準単価 1.月次移動平均単価 2.最終仕入単価

 SELECT PH.WHS_CD,                W.WHS_DESC  ,                   PH.LINE_NO ,
 CONVERT(INT,PH.PAGE_NO )  AS     PAGE_NO  ,                      PH.LOCATION ,           PH.ITEM_NO ,
 I.ITEM_DESC ,                    PH.JOC_CD   ,                   PH.LOT_NO  ,            PH.PHYSICAL_CNT_QTY,  
 PH.INV_BAL  ,                    S.DATA_CHAR AS USMR_NAME ,      PH.DIFF_QTY ,
 PH.PHYSICAL_CNT_YYMM,
 CASE @PRC_TYPE
      WHEN 0 THEN ISNULL(P1.STD_PRC,0)     --//評価単価=「標準単価」の場合
      WHEN 1 THEN ISNULL(P2.MA_PRC,0)      --//評価単価=月次移動平均単価の場合
      WHEN 2 THEN ISNULL(P2.LAST_RCV_PRC,0)--//評価単価=最終仕入単価の場合
 END  STD_PRC,
 CASE @PRC_TYPE
      WHEN 0 THEN PH.PHYSICAL_CNT_QTY*ISNULL(P1.STD_PRC,0)
      WHEN 1 THEN PH.PHYSICAL_CNT_QTY*ISNULL(P2.MA_PRC,0)
      WHEN 2 THEN PH.PHYSICAL_CNT_QTY*ISNULL(P2.LAST_RCV_PRC,0)
 END  PHYSICAL_CNT_AMT,
 CASE @PRC_TYPE
      WHEN 0 THEN PH.DIFF_QTY*ISNULL(P1.STD_PRC,0)
      WHEN 1 THEN PH.DIFF_QTY*ISNULL(P2.MA_PRC,0)
      WHEN 2 THEN PH.DIFF_QTY*ISNULL(P2.LAST_RCV_PRC,0)
 END  DIFF_AMT,
 CASE @PRC_TYPE
      WHEN 0 THEN ISNULL(P1.AMT_DEC,S1.AMT_DEC)
      WHEN 1 THEN S1.AMT_DEC
      WHEN 2 THEN S1.AMT_DEC
 END  AMT_DEC,
 CASE @PRC_TYPE
      WHEN 0 THEN ISNULL(P1.PRC_DEC,S1.PRC_DEC)
      WHEN 1 THEN S1.PRC_DEC
      WHEN 2 THEN S1.PRC_DEC
 END  PRC_DEC
 FROM PHISICAL_COUNT  PH
 LEFT JOIN WAREHOUSE_MASTER W ON PH.WHS_CD=W.WHS_CD
 LEFT JOIN ITEM_MASTER  I     ON  PH.ITEM_NO=I.ITEM_NO
 LEFT JOIN SYSTEM_PARAMETER S ON S.KEY01='ITEM_UMSR' AND S.KEY02=PH.ITEM_UMSR
 LEFT JOIN ( --評価単価-標準単価
            SELECT  SPM.ITEM_NO,          SPM.STD_PRC,         SPM.CURRENCY
                   ,S.DATA_DEC PRC_DEC,S.DATA_DEC2 AMT_DEC
            FROM STD_PRICE_MASTER SPM
            LEFT JOIN  SYSTEM_PARAMETER S ON S.KEY01 = 'CURRENCY_CD' AND S.KEY02 = SPM.CURRENCY
            WHERE BEG_EFF_DATE   <=   @PHYSICAL_CNT_YYMM
            AND   END_EFF_DATE   >=   @PHYSICAL_CNT_YYMM
           ) P1   ON PH.ITEM_NO = P1.ITEM_NO
 LEFT JOIN ( --評価単価-月次移動平均単価、最終仕入単価
            SELECT  WHS_CD,    ITEM_NO,     MA_PRC,    LAST_RCV_PRC
            FROM MONTHLY_INV
            WHERE YYMM    =   @PHYSICAL_CNT_YYMM
            AND  (WHS_CD   =   @WHS_CD or @WHS_CD = '')
           ) P2   ON  PH.WHS_CD    = P2.WHS_CD
                  AND PH.ITEM_NO   = P2.ITEM_NO
 LEFT JOIN ( --基軸通貨 S #
            SELECT ISNULL(DATA_DEC,0) PRC_DEC ,ISNULL(DATA_DEC2,0) AMT_DEC  
            FROM SYSTEM_PARAMETER
            WHERE KEY01     = 'CURRENCY_CD'
            AND   DATA_INT  = 1
           ) S1  ON 1=1
 WHERE 1=1
 AND PH.INV_WIP_TYPE=0
 AND PH.INV_TYPE=0 
 AND PH.PHYSICAL_CNT_STATUS=30
 AND (PH.PHYSICAL_CNT_QTY!=0 OR PH.DIFF_QTY!=0)
 AND (PH.PHYSICAL_CNT_YYMM = @PHYSICAL_CNT_YYMM or @PHYSICAL_CNT_YYMM = 0)
 AND (PH.WHS_CD = @WHS_CD or @WHS_CD = '')
 ORDER BY PH.PHYSICAL_CNT_YYMM, PH.WHS_CD, PH.PAGE_NO, PH.LINE_NO