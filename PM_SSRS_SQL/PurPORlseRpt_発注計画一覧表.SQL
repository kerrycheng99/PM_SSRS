--発注計画一覧表SQL(PurPORlseRpt)
DECLARE @BUYER_CD VARCHAR(10),
        @SCH_ID VARCHAR(10),
        @VENDOR_CD VARCHAR(10),
        @SCH_START_DATE INT,
        @JOC_CD VARCHAR(20),
        @CATG_CD VARCHAR(10),
        @PO_CUR VARCHAR(10),
        @PO_AMT DECIMAL(12,2),--金額
        @AMT_SCOPE CHAR(1)    --0.まで  1.以上
SET @BUYER_CD=''
SET @SCH_ID=''
SET @VENDOR_CD=''
SET @SCH_START_DATE=0
SET @JOC_CD=''
SET @CATG_CD=''
SET @PO_CUR=''
SET @PO_AMT=1500
SET @AMT_SCOPE='0'

SELECT
PO.SCH_START_DATE, 
PO.BUYER_CD,S_BUYER_NAME.DATA_CHAR BUYER_NAME,PO.SCH_ID,S_SCH_NAME.DATA_CHAR SCH_NAME,  
PO.ORDER_NO,PO.ITEM_NO,PO.ITEM_DESC,PO.PO_QTY,S_PUMSR_NAME.DATA_CHAR PUMSR_NAME,
PO.VENDOR_CD,       VM.VENDOR_NAME,                 ISNULL(CASE PPM.COM_PRC_FLAG
WHEN 1 THEN PPM.TENTATIVE_PRC WHEN 0 THEN PPM.ACT_PRC END,0) PRICE,
(PO.PO_QTY * ISNULL(CASE PPM.COM_PRC_FLAG WHEN 1 THEN PPM.TENTATIVE_PRC
WHEN 0 THEN PPM.ACT_PRC END,0)) PO_AMT,
S_CUR_NAME2.DATA_CHAR PO_CUR,S_BASE_CUR.DATA_DEC3 CUR_RATIO,PO.PO_DUE_DATE,
(PO.PO_QTY * ISNULL(CASE PPM.COM_PRC_FLAG WHEN 1 THEN PPM.TENTATIVE_PRC
WHEN 0 THEN PPM.ACT_PRC END,0) * S_BASE_CUR.DATA_DEC3) BASE_AMT
,ISNULL(CASE WHEN ISNULL(S_CUR_NAME2.DATA_CHAR,'' )='' THEN S_BASE_CUR.DATA_DEC ELSE S_CUR_NAME2.DATA_DEC END,0) PRC_DEC 
,ISNULL(CASE WHEN ISNULL(S_CUR_NAME2.DATA_CHAR,'' )='' THEN S_BASE_CUR.DATA_DEC2 ELSE S_CUR_NAME2.DATA_DEC2 END,0) AMT_DEC
FROM PLANNED_ORDER PO
INNER JOIN ITEM_MASTER IM ON PO.ITEM_NO = IM.ITEM_NO
LEFT OUTER JOIN PURCHASE_PRICE_MASTER PPM1 ON PO.ITEM_NO = PPM1.ITEM_NO   
     AND PO.VENDOR_CD = PPM1.VENDOR_CD AND PO.WS_CD = CASE WHEN PPM1.WS_CD = '*' THEN '' ELSE PPM1.WS_CD END  
     AND PO.PROCESS_CD = PPM1.PROCESS_CD
     AND PO.SCH_START_DATE >= PPM1.BEG_EFF_DATE
     AND PO.SCH_START_DATE <= PPM1.END_EFF_DATE
     AND PPM1.UNIT_PRC_BASE = 0    --0: 発注日単価採用
     AND PPM1.PRC_LOT_SIZE =dbo.FUNC_GET_PRC_LOT_SIZE(PO.ITEM_NO,PO.WS_CD,PO.PROCESS_CD,PO.VENDOR_CD,PO.SCH_START_DATE,PO.PO_QTY,0)
LEFT OUTER JOIN PURCHASE_PRICE_MASTER PPM2 ON PO.ITEM_NO = PPM2.ITEM_NO
     AND PO.VENDOR_CD = PPM2.VENDOR_CD AND PO.WS_CD = CASE WHEN PPM2.WS_CD = '*' THEN '' ELSE PPM2.WS_CD END   
     AND PO.PROCESS_CD = PPM2.PROCESS_CD
     AND PO.SCH_COMPL_DATE >= PPM2.BEG_EFF_DATE
     AND PO.SCH_COMPL_DATE <= PPM2.END_EFF_DATE
     AND PPM2.UNIT_PRC_BASE = 1    --1: 納期単価採用
     AND PPM2.PRC_LOT_SIZE =dbo.FUNC_GET_PRC_LOT_SIZE(PO.ITEM_NO,PO.WS_CD,PO.PROCESS_CD,PO.VENDOR_CD,PO.SCH_COMPL_DATE,PO.PO_QTY,1)
LEFT OUTER JOIN PURCHASE_PRICE_MASTER PPM ON PO.ITEM_NO = PPM.ITEM_NO
     AND PO.VENDOR_CD = PPM.VENDOR_CD AND PO.WS_CD = CASE WHEN PPM.WS_CD = '*' THEN '' ELSE PPM.WS_CD END
     AND PO.PROCESS_CD = PPM.PROCESS_CD
     AND ISNULL(CASE WHEN ISNULL((CASE WHEN ISNULL(PPM1.BEG_EFF_DATE,-1) = -1 THEN PPM1.END_EFF_DATE ELSE PPM1.BEG_EFF_DATE END),-1) = -1
                THEN (CASE WHEN ISNULL(PPM2.BEG_EFF_DATE,-1) = -1 THEN PPM2.END_EFF_DATE ELSE PPM2.BEG_EFF_DATE END)
                ELSE (CASE WHEN ISNULL(PPM1.BEG_EFF_DATE,-1) = -1 THEN PPM1.END_EFF_DATE ELSE PPM1.BEG_EFF_DATE END) END, 0)
         >= PPM.BEG_EFF_DATE
     AND ISNULL(CASE WHEN ISNULL((CASE WHEN ISNULL(PPM1.BEG_EFF_DATE,-1) = -1 THEN PPM1.END_EFF_DATE ELSE PPM1.BEG_EFF_DATE END),-1) = -1
                THEN (CASE WHEN ISNULL(PPM2.BEG_EFF_DATE,-1) = -1 THEN PPM2.END_EFF_DATE ELSE PPM2.BEG_EFF_DATE END)
                ELSE (CASE WHEN ISNULL(PPM1.BEG_EFF_DATE,-1) = -1 THEN PPM1.END_EFF_DATE ELSE PPM1.BEG_EFF_DATE END) END, 0)
         <= PPM.END_EFF_DATE
     AND PPM.UNIT_PRC_BASE =(CASE WHEN ISNULL(PPM1.BEG_EFF_DATE,-1) = -1 THEN 1 ELSE 0 END)
     AND PPM.PRC_LOT_SIZE =(CASE WHEN ISNULL(PPM1.BEG_EFF_DATE,-1) = -1 THEN PPM2.PRC_LOT_SIZE ELSE PPM1.PRC_LOT_SIZE END)
LEFT OUTER JOIN VENDOR_MASTER VM  ON PO.VENDOR_CD = VM.VENDOR_CD
LEFT OUTER JOIN SYSTEM_PARAMETER S_BUYER_NAME
     ON S_BUYER_NAME.KEY01 = 'BUYER_CD' AND S_BUYER_NAME.KEY02 = PO.BUYER_CD
LEFT OUTER JOIN SYSTEM_PARAMETER S_SCH_NAME
     ON S_SCH_NAME.KEY01 = 'SCH_ID' AND S_SCH_NAME.KEY02 = PO.SCH_ID
LEFT OUTER JOIN SYSTEM_PARAMETER S_CUR_NAME2
     ON S_CUR_NAME2.KEY01 = 'CURRENCY_CD'
     AND S_CUR_NAME2.KEY02 = (CASE ISNULL(PPM.COM_PRC_FLAG, -1)
                              WHEN -1 THEN VM.CUR_CD WHEN 0 THEN PPM.ACT_CUR ELSE PPM.TENTATIVE_CUR END)
LEFT OUTER JOIN SYSTEM_PARAMETER S_PUMSR_NAME
     ON S_PUMSR_NAME.KEY01 = 'ITEM_UMSR' AND S_PUMSR_NAME.KEY02 = PO.PO_UMSR
LEFT OUTER JOIN SYSTEM_PARAMETER S_BASE_CUR ON S_BASE_CUR.KEY01 = 'CURRENCY_CD' AND S_BASE_CUR.DATA_INT = 1
WHERE 1 = 1
  AND PO.SC_FLAG = 1 
  AND PO.ITEM_TYPE <> '99' 
  AND (PO.BUYER_CD = @BUYER_CD or @BUYER_CD = '')
  AND (PO.SCH_ID = @SCH_ID or @SCH_ID = '')
  AND (PO.VENDOR_CD = @VENDOR_CD or @VENDOR_CD = '')
  AND (PO.SCH_START_DATE  <= @SCH_START_DATE or @SCH_START_DATE = 0) 
  AND (PO.JOC_CD = @JOC_CD or @JOC_CD = '')
  AND (IM.CATG_CD = @CATG_CD or @CATG_CD = '')
  AND (CASE ISNULL(PPM.COM_PRC_FLAG, -1)
       WHEN -1 THEN VM.CUR_CD 
       WHEN 0  THEN PPM.ACT_CUR 
       ELSE PPM.TENTATIVE_CUR END = @PO_CUR
       or @PO_CUR = '')
  AND ( (@PO_AMT != 0 and (
          (@AMT_SCOPE  = '0' and ((PO.PO_QTY * ISNULL(CASE PPM.COM_PRC_FLAG WHEN 1 THEN PPM.TENTATIVE_PRC WHEN 0 THEN PPM.ACT_PRC END,0)) <= @PO_AMT))
           or
          (@AMT_SCOPE != '0' and ((PO.PO_QTY * ISNULL(CASE PPM.COM_PRC_FLAG WHEN 1 THEN PPM.TENTATIVE_PRC WHEN 0 THEN PPM.ACT_PRC END,0)) >= @PO_AMT))
        ))
        or @PO_AMT = 0)
ORDER BY PO.BUYER_CD, PO.SCH_ID, PO.ORDER_NO, PO.ITEM_NO 
