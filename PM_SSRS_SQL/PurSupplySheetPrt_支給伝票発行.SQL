--PurSupplySheetPrt_支給伝票発行
DECLARE @BUYER_CD VARCHAR(10),
        @TO_VC_CD VARCHAR(10),
        @TO_CUR VARCHAR(10),
        @TRANS_DATE INT,
        @REISSUE_FLAG INT   --0発行の場合 1.再発行の場合
SET @BUYER_CD=''
SET @TO_VC_CD=''
SET @TO_CUR=''
SET @TRANS_DATE=0
SET @REISSUE_FLAG=0

SELECT 
T.BUYER_CD, T.TO_VC_CD, T.TO_CUR
FROM TRANSFER_TRANS T
WHERE 1 = 1
  AND T.REQ_TYPE = '24' 
  AND T.BUYER_CD IN ( @BUYER_CD )
  AND T.TO_VC_CD IN ( @TO_VC_CD )
  AND ( (@REISSUE_FLAG = 0 and T.XFER_STATUS = 20 AND T.SLIP_PRINT_FLAG = 0 )  --発行の場合
         or
        (@REISSUE_FLAG = 1 and T.XFER_STATUS = 30 and ROUND(T.TRANS_DATE/100,0) = @TRANS_DATE and T.SLIP_PRINT_FLAG = 1) --再発行の場合
      )
GROUP BY T.BUYER_CD, T.TO_VC_CD, T.TO_CURS

SELECT
T.TO_VC_CD VENDOR_CD,   V.VENDOR_NAME,      S.DATA_CHAR COMPANY_CD,     T.ITEM_NO,
T.ITEM_DESC,            T.ACT_QTY QTY,      S2.DATA_CHAR ITEM_UMSR,
ACT_PRC = ISNULL(CASE WHEN T.TO_SUPPLY_TYPE = '2' THEN 0 
                      WHEN T.TO_SUPPLY_TYPE = '1' THEN T.ACT_PRC END,0),
T.ACT_QTY * ISNULL(CASE WHEN T.TO_SUPPLY_TYPE = '2' THEN 0
                        WHEN T.TO_SUPPLY_TYPE = '1' THEN T.ACT_PRC END,0) ACT_AMT,
ISNULL(S3.DATA_CHAR,'') TO_CUR, T.TO_SUPPLY_TYPE,T.BUYER_CD,
CASE ISNULL(S5.DATA_INT,0) WHEN 0 THEN  S4.DATA_INT ELSE S5.DATA_INT END LANG
,ISNULL(S3.DATA_DEC,0) PRC_DEC,    ISNULL(S3.DATA_DEC2,0) AMT_DEC
FROM TRANSFER_TRANS T
LEFT JOIN VENDOR_MASTER V ON T.TO_VC_CD   = V.VENDOR_CD
LEFT JOIN SYSTEM_PARAMETER S ON S.KEY01   = 'COMPANY_CD'  AND S.KEY02  = '*'
LEFT JOIN SYSTEM_PARAMETER S2 ON S2.KEY01 = 'ITEM_UMSR'   AND S2.KEY02 = T.ITEM_UMSR
LEFT JOIN SYSTEM_PARAMETER S3 ON S3.KEY01 = 'CURRENCY_CD' AND S3.KEY02 = T.TO_CUR
LEFT JOIN SYSTEM_PARAMETER S4 ON S4.KEY01 = 'PRINT_LANG'  AND S4.KEY02 = '*'
LEFT JOIN SYSTEM_PARAMETER S5 ON S5.KEY01 = 'COUNTRY_CD'  AND S5.KEY02 = V.COUNTRY_CD
WHERE 1 = 1
  AND T.REQ_TYPE = '24' 
  AND T.BUYER_CD IN ( @BUYER_CD )
  AND T.TO_VC_CD IN ( @TO_VC_CD )
  AND ( (@REISSUE_FLAG = 0 and T.XFER_STATUS = 20 AND T.SLIP_PRINT_FLAG = 0 )  --発行の場合
         or
        (@REISSUE_FLAG = 1 and T.XFER_STATUS = 30 and ROUND(T.TRANS_DATE/100,0) = @TRANS_DATE and T.SLIP_PRINT_FLAG = 1) --再発行の場合
      )
 ORDER BY T.TO_VC_CD,S3.DATA_CHAR,T.ITEM_NO,T.TO_SUPPLY_TYPE
