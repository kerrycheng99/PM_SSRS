--InvDisbList_部品出庫指示一覧表 SQL
DECLARE @IS_REISSUE Bit = 1              --発行分類: 0.発行 1.再発行
DECLARE @WHS_CD VARCHAR(10) = ''
DECLARE @SLIP_NO VARCHAR(MAX)='I000000234'

 SELECT
 T.XFER_SCH_DATE,    T.SLIP_NO,              T.TO_WS_CD,     WS.WS_DESC,
 T.FROM_WHS_CD,      W.WHS_DESC,             D.SEQ_NO,       T.ITEM_NO,      T.ITEM_DESC,
 D.ALLOC_QTY,        S.DATA_CHAR ITEM_UMSR,  D.LOCATION,     D.LOT_NO,       D.JOC_CD,
 T.TO_VC_CD,         V.VENDOR_NAME,          T.REQ_TYPE,
 T.TO_PROCESS_CD,    P.PROCESS_DESC,         T.SLIP_LINE_NO
 ,S2.DATA_INT
 ,(CASE T.REQ_TYPE WHEN '21' THEN J.JOB_ORDER_NO WHEN '24' THEN PUR.JOB_ORDER_NO END) AS JOB_ORDER_NO
 ,ISNULL(S3.DATA_DEC,0) PRC_DEC,        ISNULL(S3.DATA_DEC2,0) AMT_DEC
 FROM TRANSFER_TRANS T
 INNER JOIN DISB_ALLOC D ON T.XFER_NO=D.XFER_NO
 LEFT OUTER JOIN WORKSHOP_MASTER WS ON T.TO_WS_CD=WS.WS_CD
 LEFT OUTER JOIN WAREHOUSE_MASTER W ON T.FROM_WHS_CD=W.WHS_CD
 LEFT OUTER JOIN VENDOR_MASTER V ON T.TO_VC_CD=V.VENDOR_CD
 LEFT OUTER JOIN PROCESS_MASTER P ON T.TO_WS_CD=P.WS_CD AND T.TO_PROCESS_CD=P.PROCESS_CD
 LEFT OUTER JOIN SYSTEM_PARAMETER S ON S.KEY01='ITEM_UMSR' AND S.KEY02 = T.ITEM_UMSR 
 LEFT OUTER JOIN SYSTEM_PARAMETER S2 ON S2.KEY01='DISB_NUMBERING_TYPE' AND S2.KEY02 = '*' AND S2.KEY03='*' AND S2.KEY04='*'
 LEFT OUTER JOIN JOB_ORDER J ON T.ORDER_NO=J.ORDER_NO
 LEFT OUTER JOIN PUR_ORDER PUR ON T.ORDER_NO=PUR.ORDER_NO
 LEFT OUTER JOIN SYSTEM_PARAMETER S3 ON S3.KEY01 = 'CURRENCY_CD' AND S3.KEY02 = T.TO_CUR 
 WHERE 1 = 1
 AND T.REQ_TYPE IN ('21','24')
 AND NOT EXISTS ( SELECT 1 FROM PLANNED_ORDER O WHERE O.ORDER_NO = T.ORDER_NO )
 AND D.ALLOC_STATUS = 0
 AND (T.FROM_WHS_CD = @WHS_CD or @WHS_CD = '')
 AND ( (@IS_REISSUE = 0  --0.発行
        and T.XFER_STATUS=5
       ) or 
       (@IS_REISSUE = 1  --1.再発行
        AND T.SLIP_NO IN ( @SLIP_NO )
       ) 
     )
 ORDER BY T.XFER_SCH_DATE,T.FROM_WHS_CD,T.TO_WS_CD,T.SLIP_NO,D.LOCATION,T.ITEM_NO,D.LOT_NO,D.JOC_CD