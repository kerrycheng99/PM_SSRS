--WipStockTakingDiffRpt_現場棚卸差異リスト SQL
DECLARE @PHYSICAL_CNT_YYMM INT = 201502
DECLARE @WS_CD VARCHAR(10) = ''
DECLARE @PROCESS_CD VARCHAR(10) = ''
DECLARE @DIFF_RATE DECIMAL(7,2) = 0
DECLARE @DIFF_AMT DECIMAL(15,2) = 0

 SELECT  PH.WS_CD,                  WS.WS_DESC,            PH.PROCESS_CD ,
 PRO.PROCESS_DESC,                  PH.PAGE_NO,            PH.LINE_NO,
 PH.ITEM_NO,                        I.ITEM_DESC ,          PH.JOC_CD,
 PH.LOT_NO,                         PH.INV_BAL,            PH.ITEM_UMSR,
 S.DATA_CHAR AS UMSR_NAME ,         PH.PHYSICAL_CNT_QTY,   PH.DIFF_QTY ,
 PH.PHYSICAL_CNT_YYMM
 FROM  PHISICAL_COUNT PH
 LEFT JOIN WORKSHOP_MASTER WS ON WS.WS_CD=PH.WS_CD
 LEFT JOIN PROCESS_MASTER PRO ON PRO.PROCESS_CD=PH.PROCESS_CD
 LEFT JOIN SYSTEM_PARAMETER S ON S.KEY01='ITEM_UMSR' AND S.KEY02=PH.ITEM_UMSR
 LEFT JOIN ITEM_MASTER  I     ON I.ITEM_NO=PH.ITEM_NO
 WHERE 1=1
 AND PH.INV_WIP_TYPE=1 
 AND PH.INV_TYPE=0
 AND PH.PHYSICAL_CNT_STATUS>=20
 AND DIFF_QTY<>0
 AND (PH.PHYSICAL_CNT_YYMM = @PHYSICAL_CNT_YYMM or @PHYSICAL_CNT_YYMM = 0)
 AND (PH.WS_CD = @WS_CD or @WS_CD = '')
 AND (PH.PROCESS_CD = @PROCESS_CD or @PROCESS_CD = '')
 AND ( (@DIFF_RATE = 0.0) or
       (@DIFF_RATE <> 0.0
        AND ABS(CASE WHEN INV_BAL<>0 AND DIFF_QTY<>0
                THEN ABS(DIFF_QTY/INV_BAL )*100
                WHEN INV_BAL=0 AND DIFF_QTY<>0 THEN 100
                ELSE 0  END) >= @DIFF_RATE 
       )
     )
 AND ( (@DIFF_AMT = 0.0) or
       (@DIFF_AMT <> 0.0
          AND ABS(DIFF_AMT) >=@DIFF_AMT
       )
     )
 ORDER BY PH.PHYSICAL_CNT_YYMM, PH.WS_CD, PH.ITEM_NO